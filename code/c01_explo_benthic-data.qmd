---
title: "Exploration of benthic cover data"
format: html
editor: source
toc: true
toc-depth: 4
toc-expand: true
---

**_Status of Coral Reefs of the World: 2025_**

Global Coral Reef Monitoring Network (GCRMN)



```{r}
#| include: false

# 1. Load packages ----

library(tidyverse)
library(kableExtra)
library(patchwork)
library(ggtext)
library(glue)
library(sf)
sf_use_s2(FALSE)

# 2. Source functions ----

source("../code/function/graphical_par.R")
source("../code/function/theme_graph.R")
source("../code/function/prepare_benthic_data.R")
source("../code/function/plot_trends_raw.R")

# 3. Transform data ----

load("../data/02_misc/data-benthic.RData")

data_benthic_cover <- prepare_benthic_data(data = data_benthic)

rm(data_benthic)

```

## Data per category

### Global

```{r}
#| echo: false
#| message: false
#| warning: false
#| tbl-cap: Benthic categories per territory.

data_dataset <- data_benthic_cover %>% 
  select(category, datasetID) %>% 
  distinct() %>% 
  group_by(category) %>% 
  mutate(dataset = n_distinct(datasetID)) %>% 
  ungroup() %>% 
  complete(category, fill = list(dataset = 0)) %>% 
  mutate(dataset_total = n_distinct(datasetID, na.rm = TRUE)) %>% 
  mutate(Datasets = paste(dataset, "/", dataset_total)) %>% 
  select(category, Datasets) %>% 
  distinct()

data_regions <- data_benthic_cover %>% 
  select(region, category) %>% 
  distinct() %>% 
  group_by(category) %>% 
  count(name = "Regions") %>% 
  ungroup() %>% 
  mutate(Regions = paste0(Regions, " / ", length(unique(data_benthic_cover$region))))

data_subregions <- data_benthic_cover %>% 
  select(subregion, category) %>% 
  distinct() %>% 
  group_by(category) %>% 
  count(name = "Subregions") %>% 
  ungroup() %>% 
  mutate(Subregions = paste0(Subregions, " / ", length(unique(data_benthic_cover$subregion))))

data_site <- data_benthic_cover %>% 
  select(category, decimalLatitude, decimalLongitude) %>% 
  distinct() %>% 
  group_by(category) %>% 
  mutate(site = n_distinct(decimalLatitude, decimalLongitude)) %>% 
  ungroup() %>% 
  complete(category, fill = list(dataset = 0)) %>% 
  mutate(site_total = n_distinct(decimalLatitude, decimalLongitude)) %>% 
  mutate(Sites = paste(format(site, big.mark = ","), "/", format(site_total, big.mark = ","))) %>% 
  select(category, Sites) %>% 
  distinct()

data_survey <- data_benthic_cover %>% 
  select(category, decimalLatitude, decimalLongitude, year, month, day, eventDate) %>% 
  distinct() %>% 
  group_by(category) %>% 
  mutate(survey = n_distinct(decimalLatitude, decimalLongitude, year, month, day, eventDate)) %>% 
  ungroup() %>% 
  complete(category, fill = list(dataset = 0)) %>% 
  mutate(survey_total = n_distinct(decimalLatitude, decimalLongitude, year, month, day, eventDate)) %>% 
  mutate(Surveys = paste(format(survey, big.mark = ","), "/", format(survey_total, big.mark = ","))) %>% 
  select(category, Surveys) %>% 
  distinct()

left_join(data_dataset, data_regions) %>% 
  left_join(., data_subregions) %>% 
  left_join(., data_site) %>% 
  left_join(., data_survey) %>%
  rename(Category = category) %>% 
  kable(., align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

### Regional

```{r}
#| echo: false
#| message: false
#| warning: false
#| tbl-cap: Benthic categories per region.

data_dataset <- data_benthic_cover %>% 
  select(region, category, datasetID) %>% 
  distinct() %>% 
  group_by(region, category) %>% 
  mutate(dataset = n_distinct(datasetID)) %>% 
  ungroup() %>% 
  complete(region, category, fill = list(dataset = 0)) %>%
  group_by(region) %>% 
  mutate(dataset_total = n_distinct(datasetID, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(Datasets = paste(dataset, "/", dataset_total)) %>% 
  select(region, category, Datasets) %>% 
  distinct()

data_site <- data_benthic_cover %>% 
  select(region, category, decimalLatitude, decimalLongitude) %>% 
  distinct() %>% 
  group_by(region, category) %>% 
  mutate(site = n_distinct(decimalLatitude, decimalLongitude)) %>% 
  ungroup() %>% 
  complete(region, category, fill = list(site = 0)) %>% 
  group_by(region) %>% 
  mutate(site_total = n_distinct(decimalLatitude, decimalLongitude, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(Sites = paste(format(site, big.mark = ","), "/", format(site_total, big.mark = ","))) %>% 
  select(region, category, Sites) %>% 
  distinct()

data_survey <- data_benthic_cover %>% 
  select(region, category, decimalLatitude, decimalLongitude, year, month, day, eventDate) %>% 
  distinct() %>% 
  group_by(region, category) %>% 
  mutate(survey = n_distinct(decimalLatitude, decimalLongitude, year, month, day, eventDate)) %>% 
  ungroup() %>% 
  complete(region, category, fill = list(survey = 0)) %>% 
  group_by(region) %>% 
  mutate(survey_total = n_distinct(decimalLatitude, decimalLongitude, year, month, day, eventDate)) %>% 
  ungroup() %>% 
  mutate(Surveys = paste(format(survey, big.mark = ","), "/", format(survey_total, big.mark = ","))) %>% 
  select(region, category, Surveys) %>% 
  distinct()

left_join(data_dataset, data_site) %>% 
  left_join(., data_survey) %>%
  rename(Category = category, Region = region) %>% 
  kable(., align = "c") %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

## Distribution

### Global

```{r}
#| echo: false
#| message: false
#| warning: false

ggplot() +
  geom_density(data = data_benthic_cover, aes(x = measurementValue), fill = "lightgrey") +
  facet_wrap(~category, ncol = 3) +
  theme_graph() + 
  lims(x = c(0, 100)) +
  labs(x = "Percentage cover", y = "Density") +
  theme(strip.text = element_text(hjust = 0.5, face = "bold"),
        text = element_text(size = 9),
        axis.text = element_text(size = 10),
        strip.text.x = element_text(size = 10),
        strip.background = element_rect(color = NA, fill = "white"))

```

### Regional

```{r}
#| echo: false
#| message: false
#| warning: false
#| fig-height: 5

plot_density <- function(region_i){
  
  data_benthic_cover_i <- data_benthic_cover %>% 
  filter(region == region_i)

  ggplot() +
    geom_density(data = data_benthic_cover, aes(x = measurementValue), fill = "lightgrey", alpha = 0.7) +
    geom_density(data = data_benthic_cover_i, aes(x = measurementValue), fill = "#89c4f4", alpha = 0.7) +
    facet_wrap(~category, scales = "free") +
    theme_graph() + 
    lims(x = c(0, 100)) +
    labs(x = "Cover", y = "Density", title = region_i) +
    theme(strip.text = element_text(hjust = 0.5, face = "bold"),
          text = element_text(size = 9),
          axis.text = element_text(size = 10),
          strip.text.x = element_text(size = 10),
          plot.title = element_text(color = "#89c4f4", size = 15, face = "bold"),
          strip.background = element_rect(color = NA, fill = "white"))
  
}

map(sort(unique(data_benthic_cover$region)), ~plot_density(region_i = .x))

```

## Raw trends

```{r}
#| echo: false
#| message: false
#| warning: false

# Region ----

plot_trends_raw(level_i = "region")

# Subregion ----

map(unique(color_regions$region),
    ~plot_trends_raw(level_i = "subregion", region_i = .x, category_i = "Hard coral"))

map(unique(color_regions$region),
    ~plot_trends_raw(level_i = "subregion", region_i = .x, category_i = "Macroalgae"))

# Ecoregion ----

map(unique(color_regions$region),
    ~plot_trends_raw(level_i = "ecoregion", region_i = .x, category_i = "Hard coral"))

map(unique(color_regions$region),
    ~plot_trends_raw(level_i = "ecoregion", region_i = .x, category_i = "Macroalgae"))

```
